@page "/perfil/{id:int}"

@inject IUsuarioService usuarioService;
@inject IToastService toastService;
@inject NavigationManager _navService;

<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
        <meta name="description" content="" />
        <meta name="author" content="" />

        <link href="assets/css/pages/perfil.css" rel="stylesheet" />
</head>
    <body class="d-flex flex-column h-100">

<div class="my-account-wrapper mt-no-text">
    <div class="container container-default-2 custom-area">
        <div class="row">
            <div class="col-lg-12 col-custom">
                <!-- My Account Page Start -->
                <div class="myaccount-page-wrapper">
                    <!-- My Account Tab Menu Start -->
                    <div class="row">
                        <div class="col-lg-3 col-md-4 col-custom">
                            <div class="myaccount-tab-menu nav" role="tablist">
                                <a href="#dashboad" class="active" data-bs-toggle="tab" aria-selected="true" role="tab">
                                    <i class="fa fa-dashboard"></i>
                                    Dashboard
                                </a>
                                <a href="#orders" data-bs-toggle="tab" aria-selected="false" role="tab" class="" tabindex="-1"><i class="fa fa-cart-arrow-down"></i> Ordenes</a>
                                <a href="#account-info" data-bs-toggle="tab" aria-selected="false" role="tab" class="" tabindex="-1"><i class="fa fa-user"></i> Mi cuenta</a>
                                <a href="#password" data-bs-toggle="tab" aria-selected="false" role="tab" class="" tabindex="-1"><i class="fa fa-key"></i> Contraseña</a>
                                <a href="#address-edit" data-bs-toggle="tab" aria-selected="false" role="tab" class="" tabindex="-1"><i class="fa fa-map-marker"></i> Direcciones</a>
                                <a href="#payment-method" data-bs-toggle="tab" aria-selected="false" role="tab" class="" tabindex="-1"><i class="fa fa-credit-card"></i> Metodos de pago</a>
                            </div>
                        </div>
                        <!-- My Account Tab Menu End -->
                        <!-- My Account Tab Content Start -->
                        <div class="col-lg-9 col-md-8 col-custom">
                            <div class="tab-content" id="myaccountContent">
                                <!-- Single Tab Content Start -->
                                <div class="tab-pane fade active show" id="dashboad" role="tabpanel">
                                    <div class="myaccount-content">
                                        <h3>Dashboard</h3>
                                        <div class="welcome">
                                            <p>Hola,  @modelo.NombreCompleto</p>
                                        </div>
                                            <p class="mb-0">Desde el panel de su cuenta. Puede verificar y ver fácilmente sus pedidos recientes, administrar sus direcciones de envío y facturación y editar su contraseña y detalles de su cuenta.</p>
                                    </div>
                                </div>
                                <!-- Single Tab Content End -->
                                <!-- Single Tab Content Start -->
                                <div class="tab-pane fade" id="orders" role="tabpanel">
                                    <div class="myaccount-content">
                                        <h3>Ordenes</h3>
                                        <div class="myaccount-table table-responsive text-center">
                                            <table class="table table-bordered">
                                                <thead class="thead-light">
                                                    <tr>
                                                        <th>Orden</th>
                                                        <th>Fecha</th>
                                                        <th>Estado</th>
                                                        <th>Total</th>
                                                        <th>Acción</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr>
                                                        <td>1</td>
                                                        <td>Aug 22, 2022</td>
                                                        <td>Pendiente</td>
                                                        <td>$3000</td>
                                                            <td><a href="cart.html" class="btn btn-outline-dark btn-lg px-2">Detalles</a></td>
                                                    </tr>
                                                    <tr>
                                                        <td>2</td>
                                                        <td>July 22, 2022</td>
                                                        <td>Aprobada</td>
                                                        <td>$200</td>
                                                            <td><a href="cart.html" class="btn btn-outline-dark btn-lg px-2">Detalles</a></td>
                                                    </tr>
                                                    <tr>
                                                        <td>3</td>
                                                        <td>June 12, 2022</td>
                                                        <td>Completa</td>
                                                        <td>$990</td>
                                                            <td><a href="cart.html" class="btn btn-outline-dark btn-lg px-2">Detalles</a></td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <!-- Single Tab Content End -->
                                <!-- Single Tab Content Start -->
                                    <div class="tab-pane fade" id="password" role="tabpanel">
                                        <div class="myaccount-content">
                                            <h3>Cambiar la contraseña</h3>
                                            <div class="account-details-form">
                                                <EditForm Model="modelo" OnValidSubmit="SaveChanges">
                                                    <div class="single-input-item mb-3">
                                                        <label for="Contraseña anterior" class="required mb-1">Contraseña anterior</label>
                                                        <input type="password" id="claveAnterior" placeholder="Contraseña anterior" @bind-value="modelo.Clave">
                                                        <ValidationMessage For="@(()=>modelo.Clave)" />
                                                    </div>
                                                    <div class="single-input-item mb-3">
                                                        <label for="Nueva contraseña" class="required mb-1">Nueva contraseña</label>
                                                        <input type="password" id="claveNueva" placeholder="Correo" @bind-value="modelo.Clave">
                                                        <ValidationMessage For="@(()=>modelo.Clave)" />
                                                    </div>

                                                    <div class="single-input-item mb-3">
                                                        <label for="Confirmacion contraseña" class="required mb-1">Confirmar contraseña</label>
                                                        <input type="password" id="confirmarClave" placeholder="Confirmar contraseña" @bind-value="modelo.ConfirmarClave">
                                                        <ValidationMessage For="@(()=>modelo.ConfirmarClave)" />
                                                    </div>

                                                    <div class="single-input-item single-item-button">
                                                        <button class="btn btn-outline-dark btn-lg px-2">Guardar</button>
                                                    </div>
                                                </EditForm>
                                            </div>
                                        </div>
                                    </div> <!-- Single Tab Content End -->
                                <!-- Single Tab Content End -->
                                <!-- Single Tab Content Start -->
                                <div class="tab-pane fade" id="payment-method" role="tabpanel">
                                    <div class="myaccount-content">
                                        <h3>Metodos de pago</h3>
                                        <p class="saved-message">Aqui van los metodos de pago.</p>
                                    </div>
                                </div>
                                <!-- Single Tab Content End -->
                                <!-- Single Tab Content Start -->
                                <div class="tab-pane fade" id="address-edit" role="tabpanel">
                                    <div class="myaccount-content">
                                        <h3>Mis direcciones</h3>
                                        <address>
                                            <p><strong>Mi casa</strong></p>
                                            <p>
                                                Calle 19 y 38 <br>
                                                Santa Lucia del este, Canelones
                                            </p>
                                            <p>Celular: 094391883</p>
                                        </address>
                                            <a href="#" class="btn btn-outline-dark btn-lg px-2"><i class="fa fa-edit mr-2"></i> Editar dirección</a>
                                    </div>
                                </div>
                                <!-- Single Tab Content End -->
                                <!-- Single Tab Content Start -->
                                <div class="tab-pane fade" id="account-info" role="tabpanel">
                                    <div class="myaccount-content">
                                        <h3>Detalles de la cuenta</h3>
                                        <div class="account-details-form">
                                            <EditForm Model="modelo" OnValidSubmit="SaveChanges">
                                                <div class="single-input-item mb-3">
                                                    <label for="Nombre completo" class="required mb-1">Nombre Completo</label>
                                                        <input type="text" id="display-name" placeholder="Nombre Completo" @bind-value="modelo.NombreCompleto">
                                                        <ValidationMessage For="@(()=>modelo.NombreCompleto)" />
                                                </div>
                                                <div class="single-input-item mb-3">
                                                        <label for="Correo" class="required mb-1">Correo</label>
                                                        <input type="text" id="email" placeholder="Correo" @bind-value="modelo.Correo">
                                                        <ValidationMessage For="@(()=>modelo.Correo)" />
                                                </div>
                                                
                                                <div class="single-input-item single-item-button">
                                                    <button class="btn btn-outline-dark btn-lg px-2">Guardar</button>
                                                </div>
                                                </EditForm>
                                            </div>
                                    </div>
                                </div> <!-- Single Tab Content End -->
                            </div>
                        </div> <!-- My Account Tab Content End -->
                    </div>
                </div> <!-- My Account Page End -->
            </div>
        </div>
    </div>
</div>
</body>
</html>

@code {
    [Parameter] public int id { get; set; }
    private string titulo = "Nuevo Usuario";
    private string boton = "Crear";
    private UsuarioDTO modelo = new UsuarioDTO();

    protected override async Task OnParametersSetAsync()
    {
        if (id != 0)
        {
            titulo = "Editar Usuario";
            boton = "Actualizar";

            var response = await usuarioService.Get(id);
            if (response.IsCorrect!)
            {
                modelo = (UsuarioDTO)response.Result!;
                modelo.ConfirmarClave = modelo.Clave;
            }
            else
            {
                toastService.ShowWarning(response.Message);
            }
        }
    }

    private async Task SaveChanges()
    {
        if (modelo.Clave != modelo.ConfirmarClave)
        {
            toastService.ShowWarning("Las contraseñas no coinciden");
            return;
        }

        bool respuesta = true;
        string mensaje = string.Empty;

        if (id != 0)
        {
            var response = await usuarioService.Edit(modelo);
            if (response.IsCorrect)
                mensaje = "Usuario fue modificado";
            else
            {
                respuesta = false;
                mensaje = "No se pudo editar";
            }
        }
        else
        {
            modelo.Rol = "Administrador";
            var response = await usuarioService.Create(modelo);
            if (response.IsCorrect)
                mensaje = "Usuario fue creado";
            else
            {
                respuesta = false;
                mensaje = "No se pudo crear";
            }
        }

        if (respuesta)
        {
            toastService.ShowSuccess(mensaje);
            _navService.NavigateTo("/usuarios");
        }
        else
            toastService.ShowError(mensaje);
    }
}
